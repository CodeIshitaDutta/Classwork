---
title: "HW 6"
author: "Ishita Dutta, Ruize Xu, Ziyuan Li"
date: "3/7/2022"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r include = FALSE}
library(tidyverse)
```

# 1a:
```{r}
temperature = read.csv("GlobTempNASA_2020.csv", skip = 4)
colnames(temperature)
Xt = diff(temperature[,2])
par(mfrow = c(2, 2))
spec.pgram(Xt, log= "no")
spec.pgram(Xt, log = "no", spans = 5)
spec.pgram(Xt, log = "no", spans = 15)
spec.pgram(Xt, log = "no", spans = 25)
```

_Solution:_ We believe that the `spans = 15` is the plot that would be most useful, as it is not too flat like when `span = 25`, and not too rough like when `span = 5`.


# 1b:

```{r}
specselect=function(y,kmax){
# Obtains the values of the criterion function for
# obtaining the optimal number of neighbors for
# spectral density estimate for modified Daniell's method.
# input: y, observed series; kmax=max number of neighbors to
# be considered
# output: ctr - the criterion function
# output: kopt - the value of k at which the criterion function
# is minimized
ii=spec.pgram(y,log="no",plot=FALSE)

ii=ii$spec
cc=norm(as.matrix(ii),type="F")^2
ctr=rep(1,kmax) ###criterion function
for(k in 1:kmax) {
ss=2*k+1; kk=1/(2*k)
ff=spec.pgram(y,spans=ss,log="no",plot=FALSE)
fspec=ff$spec
ctr[k]=norm(as.matrix(ii-fspec),type="F")^2+kk*cc
}
kopt=which.min(ctr)
result=list(ctr=ctr,kopt=kopt)
return(result)
}

```

```{r}

specselect(Xt,12)

```
The best amount of smoothing should be 6.

# 2a:

$$
\theta=0.9, \sigma^2=4
$$

\begin{aligned}
&X_t=\epsilon_t+\theta\epsilon_{t-1}\\

&X_{t-1}=\epsilon_{t-1}+\theta\epsilon_{t-2}\\
&Then\\
&\nabla X_t=\epsilon_t+(\theta-1)\epsilon_{t-1}-\theta\epsilon_{t-2}
\end{aligned}




\begin{aligned}
&\nabla X_t=\epsilon_t+\theta_1\epsilon_{t-1}+\theta_2\epsilon_{t-2}\\
&Where\\
&\theta_1=-0.1, \ \theta_2=-0.9,\ \sigma^2=4
\end{aligned}



# 2b:



\begin{aligned}
f_{\nabla X_t}(w)&=\sum_{-\infty}^{\infty}\gamma_{\nabla X_t}(h)exp(-2\pi iwh)\\
&=\gamma_{\nabla X_t}(0)+2\sum{h=1}^{\infty}\gamma_{\nabla X_t}(h)cos(2\pi wh)\\
&=\gamma_{\nabla X_t}(0)+2\gamma_{\nabla X_t}(1)cos(2\pi w)+2\gamma_{\nabla X_t}(2)cos(4\pi w)\\
&=\sigma^2(1+\theta_1^2+\theta_2^2)+2\sigma^2(\theta_1+\theta_1\theta_2)cos(2\pi w)+2\sigma^2\theta_2cos(4\pi w)\\
&where\ \theta_1=-0.1, \ \theta_2=-0.9\\
&=4(1+0.01+0.81-2\cdot 0.01cos(2\pi w)-1.8cos(4\pi w))\\
&=7.28-0.08cos(2\pi w)-7.2cos(4\pi w)
\end{aligned}



# 2c:

We can obtain the spectral density of $X_t$ is:



\begin{aligned}
f_{X_t}(w)&=\sum_{-\infty}^{\infty}\gamma_{X_t}(h)exp(-2\pi iwh)\\
&=\gamma_{X_t}(0)+2\sum{h=1}^{\infty}\gamma_{\nabla X_t}(h)cos(2\pi wh)\\
&=\gamma_{X_t}(0)+2\gamma_{X_t}(1)cos(2\pi w)\\
&=\sigma^2(1+\\theta^2)+2\sigma^2\theta cos(2\pi w)
&where\ \theta=0.9\\
&=7.24+7.2cos(2\pi w)
\end{aligned}



Then we draw the plot.

```{r}

w<-seq(0,0.5,by=0.01)

spec_diff<-7.28-0.08*cos(2*pi*w)-7.2*cos(4*pi*w)

spec_x<-7.24+4*cos(2*pi*w)

plot(w, spec_diff, type = "l", main = "Spectral Density of first difference and original data", ylab = "spectrum")
lines(w, spec_x, col = "blue")
legend("bottom",legend = c("Xt-X(t-1)","Xt"),
lty = c(1,1), col = c("black","blue"))

```

Through the plot which is confined with $w$ from 0 to 0.5 we can find that the spectrum of $\nabla X_t$ is going up at the beginning and then going down with $w$ increasing, while the spectrum of $X_t$ is decreasing monotonously.

# 3a:


$$
\begin{aligned}

\Phi(w)&=\sum\phi(s)exp(-2\pi iws)\\
&=(2\cdot 1+exp(-2\pi iw))/4\\
&=(2+cos(2\pi w))/4-i\cdot sin(2\pi w)/4\\
\\
f_Z(w)&=|\Phi(w)|^2f_X(w)\\
&where\ f_X(w)=\sigma^2=5\\
&=5\cdot((4+4cos(2\pi w)+cos^2(2\pi w))/16+sin^2(2\pi w)/16)\\
&=(25+20cos(2\pi w))/16
\end{aligned}
$$


# 3b:
```{r}

w<-seq(0,1,by=0.01)

spec_yt<-5*(5+4*cos(2*pi*w))/16

spec_xt<-5+0*w

plot(w, spec_yt, type = "l", main = "Spectral Density of Yt and Xt",
ylab = "spectrum",ylim=c(0,6))
lines(w, spec_xt, col = "blue")
legend("topright",legend = c("Yt","Xt"),
lty = c(1,1), col = c("black","blue"))


```


We can see that the spectrum of $Y_t$ decreases at beginning and then increase a little and it has a high value around zero and another small peak at 0.5, while the plot of $X_t$ is a straight line parallel to $w$.

# 4a:

``` {r}
# question 4 part(a)
ar2 = arima.sim(list(order = c(2,0,0),ar = c(0.6266, -0.8941)), n = 90, sd = sqrt(3.622))
X89 = 34.716
X90 = 37.734
sigma2 = 3.622
mu = 30.043
X91  = 0.6266 * (X90 - mu) - 0.8941*(X89 - mu) + mu
X92 = 0.6266 * (X91 - mu) - 0.8941*(X90 - mu) + mu
X93  = 0.6266 * (X92 - mu) - 0.8941*(X91 - mu) + mu
X94  = 0.6266 * (X93 - mu) - 0.8941*(X92 - mu) + mu
X95  = 0.6266 * (X94 - mu) - 0.8941*(X93 - mu) + mu
c(X91, X92, X93, X94, X95)
```


# 4b:

```{r}
# part(b)
coef = ARMAtoMA(ar = c(0.6266,-0.8941),lag.max = 4)
coef
var1 = sigma2
var2 = (1 + (coef[1])^2) *sigma2
var3 = (1 + (coef[2])^2 + (coef[1])^2 ) *sigma2
var4 = (1 + (coef[3])^2 + (coef[2])^2 + (coef[1])^2) *sigma2
var5 = (1 + (coef[4])^2 + (coef[3])^2 + (coef[2])^2 + (coef[1])^2 ) *sigma2
error = c(var1,var2,var3,var4,var5)
error
```

# 4c:

```{r}
# part(c)
pm <- c(-1,1)
ci <- matrix(nrow=5,ncol=2)
xhat <- c(X91,X92,X93,X94,X95)
for (i in 1:5) {
ci[i,] <- xhat[i] + 1.96 * pm * sqrt(error[i])
}
ci
```

# 4d:

```{r}
# part(d)
x_true <- c(34.272,26.838,24.295,26.937,22.241)
up <- ci[,2]
low <- ci[,1]
time <- 91:95 
plot(time, x_true, type = "l", ylim = c(10,40), xlab = "X")
polygon(c(91:95,95:91), c(up,rev(low)), col='lightblue', border=NA)
lines(time, xhat,lty=2,col="red")
lines(time, x_true)
legend("top", legend = c("true","fitted"), lty=c(1, 2), col = c("black","red"))
```

# 5a:

```{r}
# 5(a) acf
r <- ARMAacf(ar = c(0.5,0.4), lag.max = 30, pacf = F)
l <- 0:30
{plot(l,r,type = "p",
main = "ACF of AR(2) phi1= 0.5, phi2=0.4", ylab = "ACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=r)
abline(h=0)}
```

For the acf plot, we can find that the value of theoretical autocorrelation decreases with the increase of the lag. Also, the values of theoretical autocorrelation are always positive.


```{r}
# 5(a) pacf
r<- ARMAacf(ar = c(0.5, 0.4), lag.max = 30, pacf = T) ##values
##to plot them:
l <- 1:30
{plot(l,r,type = "p",
main = "ACF of AR(2) phi1= 0.5, phi2=0.4", ylab = "ACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=r)
abline(h=0)}
```

For the pacf plot, we find that the value of partial autocorrelation is zero after lag2. Only values of partial autocorrelation for lag 1 and 2 are non-zero and significant here. By using the pacf plot, we can judge that the model is AR(2) only by observing the pacf plot.


# 5b:

```{r}
# 5(b) acf
r<- ARMAacf(ar = c(-0.5, 0.4), lag.max = 30, pacf = F) ##values
##to plot them:
l <- 0:30
{plot(l,r,type = "p",
main = "ACF of AR(2) phi1=-0.5, phi2=0.4", ylab = "ACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=r)
abline(h=0)}
```

For the acf plot, we can find that values of theoretical autocorrelation are not all positive this time. We have positive and negative values here.

For even lags, we have positive values and we have negative values for odd lags. For even lags, with the increase of the number of lags, the values of theoretical autocorrelation  decreases. For odd lags, the values of theoretical autocorrelation will increase with the increase of lags.


```{r}
# 5(b) pacf
r<- ARMAacf(ar = c(-0.5, 0.4), lag.max = 30, pacf = T) ##values
##to plot them:
l <- 1:30
{plot(l,r,type = "p",
main = "ACF of AR(2) phi1= -0.5, phi2=0.4", ylab = "ACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=r)
abline(h=0)}
```

For the pacf plot, we find that the value of partial autocorrelation is zero after lag2. Only values of partial autocorrelation for lag 1 and 2 are non-zero and significant here. By using the pacf plot, we can judge that the model is AR(2) only by observing the pacf plot.


# 5c:

```{r}
# 5(c) acf
r<- ARMAacf(ar = c(1.4, -0.8), lag.max = 30, pacf = F) ##values
##to plot them:
l <- 0:30
{plot(l,r,type = "p",
main = "ACF of AR(2) phi1= 1.4, phi2= -0.8", ylab = "ACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=r)
abline(h=0)}
```
For the acf plot, we can find that values of theoretical autocorrelation are fluctuating around 0 and finally converge to 0. We have positive and negative values here.

```{r}
# 5(c) pacf
r<- ARMAacf(ar = c(1.4, -0.8), lag.max = 30, pacf = T) ##values
##to plot them:
l <- 1:30
{plot(l,r,type = "p",
main = "PACF of AR(2) phi1= 1.4, phi2= -0.8", ylab = "PACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=r)
abline(h=0)}
```
For the pacf plot, we find that the value of partial autocorrelation is zero after lag 2. Only values of partial autocorrelation for lag 2 are non-zero and significant here. By using the pacf plot, we can judge that the model is AR(2) only by observing the pacf plot.



# 5d:
```{r}
# 5(d) acf
r<- ARMAacf(ar = c(-1.4, -0.8), lag.max = 30, pacf = F) ##values
##to plot them:
l <- 0:30
{plot(l,r,type = "p",
main = "ACF of AR(2) phi1= -1.4, phi2= -0.8", ylab = "ACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=r)
abline(h=0)}
```
For the acf plot, we can find that values of theoretical autocorrelation are are fluctuating around 0 and finally converge to 0. We have positive and negative values here. The fluctuation cycle is shorter than 5(c).

```{r}
# 5(d) pacf
r<- ARMAacf(ar = c(1.4, -0.8), lag.max = 30, pacf = T) ##values
##to plot them:
l <- 1:30
{plot(l,r,type = "p",
main = "PACF of AR(2) phi1= 1.4, phi2= -0.8", ylab = "ACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=r)
abline(h=0)}
```
For the pacf plot, we find that the value of partial autocorrelation is zero after lag 2. Only values of partial autocorrelation for lag 1 are non-zero and significant here. By using the pacf plot, we can judge that the model is AR(2) only by observing the pacf plot.

# 5e:
```{r}
# 5(e) acf
p<- ARMAacf(ar = c(-1.4,-0.8), ma = c(-1.1, 0.3), lag.max = 30, pacf = F)
##plot
l <- 0:30 
{plot(l,p,type = "p",
main = "ACF of ARMA(2,2)", ylab = "ACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=p)
abline(h=0)}
```
For the acf plot, we can find that values of theoretical autocorrelation are are fluctuating around 0 and finally converge to 0. We have positive and negative values here. 


```{r}
# 5(e) pacf
p<- ARMAacf(ar = c(-1.4,-0.8), ma = c(-1.1, 0.3), lag.max = 30, pacf = T)
##plot
l <- 1:30 
{plot(l,p,type = "p",
main = "PACF of ARMA(2,2)", ylab = "PACF",xlab = "Lag")
segments(x0=l, y0=0, x1=l, y1=p)
abline(h=0)}
```
For the pacf plot, we find that the value of partial autocorrelation gradually decreases to 0. By using the pacf plot, we can judge that the model is ARIMA model with both AR and MA by observing the pacf plot.

# Code Appendix 
```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```
















